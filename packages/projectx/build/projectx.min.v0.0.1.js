"use strict";(()=>{var ie=Object.defineProperty,ae=Object.defineProperties;var oe=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var W=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable;var O=(n,t,e)=>t in n?ie(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,h=(n,t)=>{for(var e in t||(t={}))W.call(t,e)&&O(n,e,t[e]);if(y)for(var e of y(t))_.call(t,e)&&O(n,e,t[e]);return n},z=(n,t)=>ae(n,oe(t));var B=(n,t)=>{var e={};for(var r in n)W.call(n,r)&&t.indexOf(r)<0&&(e[r]=n[r]);if(n!=null&&y)for(var r of y(n))t.indexOf(r)<0&&_.call(n,r)&&(e[r]=n[r]);return e};var a=(n,t,e)=>(O(n,typeof t!="symbol"?t+"":t,e),e);var R=class{constructor(){a(this,"batches",[])}open(){this.batches.push(new Set)}action(t){if(!this.batches.length)return t();this.batches[this.batches.length-1].add(t)}close(){let t=this.batches.pop();t&&t.forEach(e=>e())}},D=R;var P=class{constructor(){a(this,"listeners",new Set)}register(t){this.listeners.add(t)}unregister(t){this.listeners.delete(t)}emit(t){this.listeners.size&&Array.from(this.listeners).pop()(t)}},U=P;var w=class{constructor(){a(this,"reactions",{})}add(t,e){this.reactions[t]=e}delete(t){return delete this.reactions[t]}get(t){return this.reactions[t]}},$=w;var N=class{constructor(){a(this,"managers",{})}add(t){this.managers[t.name]=t}get(t){return this.managers[t]}getByPathRec(t,[e,...r]){return t.name===e?t:r.length?this.getByPathRec(t.managers[e],r):t.managers[e]}getByPath([t,...e]){return this.getByPathRec(this.managers[t],e)}},G=N;var M=new G,d=new U,f=new D,j=new $;function ce(){let n=0;return()=>n++}var I=ce();function H(n){return n&&typeof n=="object"&&!Array.isArray(n)}function K(n){return n&&{}.toString.call(n)==="[object Function]"}function A(n="ObservableState"){return`${n}$${I()}`}function m(n){return Promise.resolve().then(n)}function J(n,t=[]){let e=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(n)),r={};for(let s in e){let i=e[s];!i.writable&&i.get&&!i.set&&!t.includes(s)&&(r[s]=i)}return r}function Q(n,t){return n.length!==t.length?!1:n.every(e=>t.indexOf(e)!==-1)}var u={observer:{observable:!0},value:{observable:!0},computed:{observable:!0,memoised:!0},array:{observable:!0}};function b(n,t){return Array.isArray(n)?new T(n,t):H(n)?new g(n,t):n instanceof Set||n instanceof Map?n:new C(n,t)}var E=class{constructor(){a(this,"listeners",new Set)}listen(t){return this.listeners.add(t),()=>{this.listeners.delete(t)}}emit(t){for(let e of this.listeners)if(e(t))break}},x=class{constructor(){a(this,"listenerMap",new Map);a(this,"observable",!0)}listen(t,e){if(!this.observable)return()=>{};let r=[],s=Array.isArray(t)?t:[t];for(let i of s){let o=this.listenerMap.get(i)||new E;this.listenerMap.set(i,o),r.push(o.listen(e))}return()=>{r.forEach(i=>i())}}emit(t,e){if(!this.observable||e.current===e.prev)return;let r=this.listenerMap.get(t),s=this.listenerMap.get("all");r&&r.emit(e),s&&s.emit(e)}};var S=class extends x{constructor({path:e,annotation:r},s){super();a(this,"annotation",{});a(this,"path",[]);this.path=e,this.annotation=h(h({},s),r),this.observable=this.annotation.observable}dispose(){this.path=[],this.disposeManagers(),this.emit("dispose",{prev:this.snapshot})}reportUsage(){this.annotation.observable&&d.emit({path:this.path})}joinToPath(e){return[...this.path,String(e)]}get name(){return this.path[this.path.length-1]}get snapshot(){return this.target}get keys(){return[]}toString(){return String(this.snapshot)}disposeManagers(){}},l=S;var v=class{constructor(t,e){this.value=t;this.manager=e;a(this,"children",{});a(this,"listenTypes",[])}get keys(){return Object.keys(this.children)}push([t,...e]){let r=this.children[t]||new v(t,this.manager.manager(t));if(this.children[t]=r,!!e.length)return r.push(e)}},F=class{constructor(t){a(this,"nodes",{});for(let[e,...r]of t)this.nodes[e]=this.nodes[e]||new v(e,M.get(e)),this.nodes[e].push(r);for(let e in this.nodes)this.linkingRec(this.nodes[e])}linkingRec(t){let e=Object.keys(t.children);if(!e.length)return t.listenTypes=["all"];t.listenTypes=Q(e,t.manager.keys)?["add","change","remove"]:["change"];for(let r of e)this.linkingRec(t.children[r])}optimizedRec(t){let e=[{listenTypes:t.listenTypes,manager:t.manager}];if(!t.keys.length)return e;for(let r in t.children)e=e.concat(this.optimizedRec(t.children[r]));return e}getListenManagers(){let t=[];for(let e in this.nodes)t=t.concat(this.optimizedRec(this.nodes[e]));return t}},X=F;var c=class{constructor(t=`Reaction#${I()}`){this.id=t;a(this,"paths",[]);a(this,"unsubscribeFns",[]);a(this,"listener",({path:t})=>{this.paths.push(t)});a(this,"unlisten",()=>{this.unsubscribeFns.length&&(this.unsubscribeFns.forEach(t=>t()),this.unsubscribeFns=[])});j.add(t,this)}getPathTree(){return this.paths.length?new X(this.paths):null}dispose(){j.delete(this.id),this.paths=[],this.unlisten()}startWatch(){this.paths=[],d.register(this.listener)}endWatch(){d.unregister(this.listener)}watch(t){let e=this.getPathTree();if(!e)return console.warn(`Instances for listen in reaction \`${this.id}\` not found. Reconsider the use of adverse reactions.`),()=>{};let r=e.getListenManagers(),s=()=>t(this.unlisten);return this.unlisten(),this.unsubscribeFns=r.map(({listenTypes:i,manager:o})=>o.listen(i,()=>{f.action(s)})),this.unlisten}syncCaptured(t){this.startWatch();let e=t();return this.endWatch(),e}};var k=class extends l{constructor(e,r){super(r,u.computed);this.target=e;a(this,"reaction");a(this,"savedResult");a(this,"isMemoized",!1);a(this,"isChanged",!1);a(this,"managers",null);this.reaction=new c(`Computed#${this.path.join(".")}`),this.emit("define",{current:this.snapshot})}manager(){return null}get snapshot(){return this.target()}get value(){let{memoised:e}=this.annotation;return e?()=>(this.reportUsage(),this.isMemoized&&!this.isChanged?this.savedResult:(this.savedResult=this.reaction.syncCaptured(this.target),this.isMemoized=!0,this.isChanged=!1,this.reaction.watch(()=>{this.isChanged=!0,m(()=>{this.emit("change",{current:void 0,prev:this.savedResult})})}),this.savedResult)):this.target}set(){return!1}dispose(){this.reaction.dispose(),super.dispose()}},Y=k;var V=class extends l{constructor(e,r){super(r,u.observer);this.target=e;a(this,"managers",{});a(this,"proxy");a(this,"handlers",{deleteProperty:(e,r)=>{let s=this.managers[r],i=delete this.managers[r];return i&&(s.dispose(),this.emit("remove",{prev:s.value})),i},defineProperty:(e,r,s)=>{let i=this.defineProp(r,s,this.annotations.fields[String(r)]);return this.emit("add",{current:this.value}),i}});this.proxy=this.define(e)}get annotations(){let e=this.target.annotation||{};return h({fields:{},getters:{}},e)}defineProp(e,{value:r,configurable:s=!0,enumerable:i=!0},o){return this.managers[e]=b(r,{path:this.joinToPath(e),annotation:o}),Object.defineProperty(this.target,e,{configurable:s,enumerable:i,get:()=>this.managers[e].value,set:p=>this.managers[e].set(p)}),!0}defineComp(e,o,i){var p=o,{get:r}=p,s=B(p,["get"]);this.managers[e]=new Y(r.bind(this.target),{path:this.joinToPath(e),annotation:i}),Object.defineProperty(this.target,e,z(h({},s),{get:this.managers[e].value}))}get snapshot(){return Object.entries(this.managers).reduce((e,[r,s])=>Object.assign(e,{[r]:s.snapshot}),{})}get value(){return this.reportUsage(),this.proxy}get keys(){return Object.keys(this.managers)}set(e){this.target=e;let r=h({},this.target);return this.proxy=this.define(e),this.emit("change",{current:e,prev:r}),!0}disposeManagers(){for(let e in this.managers)this.managers[e].dispose();this.managers={}}manager(e){return this.managers[e]}define(e){this.disposeManagers();let r=new Proxy(e,this.handlers),s=J(e,["annotation"]),i=this.annotations;for(let o in e)this.defineProp(o,{value:e[o]},i.fields[o]);for(let o in s)this.defineComp(o,s[o],i.getters[o]);return r}},g=V;var L=class extends l{constructor(e,r){super(r,u.value);this.target=e;this.emit("define",{current:e})}get value(){return this.reportUsage(),this.target}set(e){let r=this.target;return this.target=e,this.emit("change",{current:e,prev:r}),!0}manager(){return null}},C=L;var q=class extends l{constructor(e,r){super(r,u.array);this.target=e;a(this,"managers",[]);a(this,"proxy");a(this,"handlers",{get:(e,r)=>{var o;let s=Number(r);if(!Number.isNaN(s))return(o=this.managers[s])==null?void 0:o.value;let i=this.target[r];return K(i)?(...p)=>i.call(this.proxy,...p):i},set:(e,r,s)=>{let i=Number(r);if(!Number.isNaN(i)){if(i in this.managers)return this.managers[i].set(s);try{return this.managers[i]=b(s,{path:this.joinToPath(r)}),this.target[i]=s,this.emit("add",{current:this.value}),!0}catch(o){return!1}}return this.target[r]=s,!0},deleteProperty:(e,r)=>{let s=Number(r);if(Number.isNaN(s)||!(s in this.target))return!1;let i=this.managers[s],o=this.target.splice(s,1).length===1;return o&&i&&(this.managers.splice(s,1),i.dispose()),o}});this.proxy=this.define(e),this.emit("define",{current:this.value})}set(e){let r=this.value;return this.target=e,this.proxy=this.define(e),this.emit("change",{current:e,prev:r}),!0}get snapshot(){return[...this.target]}get keys(){let e=[];for(let r in this.target)e.push(r);return e}get value(){return this.reportUsage(),this.proxy}manager(e){return this.managers[Number(e)]}disposeManagers(){for(let e of this.managers)e.dispose();this.managers=[]}define(e){this.disposeManagers();for(let r of e)this.managers.push(b(r,{path:this.joinToPath(String(this.managers.length))}));return new Proxy(e,this.handlers)}},T=q;function Z(n){return M.add(n),n.value}var ee={object:n=>Z(new g(n,{path:[A()]})),class:n=>Z(new g(new n,{path:[A(n.name)]})),array:n=>new T(n,{path:[A()]}),map:n=>n,set:n=>n};function te(n,t,{isEqual:e=(s,i)=>s===i,initialCall:r=!1}={}){let s=new c,i=s.syncCaptured(n);r&&t(i,void 0);let o=()=>{let p=s.syncCaptured(n);e(p,i)||(t(p,i),i=p),m(()=>s.watch(o))};return s.watch(o),()=>{s.dispose()}}function ne(n){let t=new c;t.syncCaptured(n);let e=()=>{t.syncCaptured(n),m(()=>t.watch(e))};return t.watch(e),()=>{t.dispose()}}function re(n,t=e=>Boolean(e)){let e=new c;return new Promise(r=>{let s=e.syncCaptured(n),i=o=>{t(o)&&(r(o),e.dispose())};e.watch(()=>{i(n())}),i(s)})}function se(n){f.open(),n(),f.close()}})();
