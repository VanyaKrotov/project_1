"use strict";(()=>{var et=Object.defineProperty,nt=Object.defineProperties;var rt=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var O=(n,e,t)=>e in n?et(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,l=(n,e)=>{for(var t in e||(e={}))L.call(e,t)&&O(n,t,e[t]);if(M)for(var t of M(e))U.call(e,t)&&O(n,t,e[t]);return n},q=(n,e)=>nt(n,rt(e));var _=(n,e)=>{var t={};for(var r in n)L.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&M)for(var r of M(n))e.indexOf(r)<0&&U.call(n,r)&&(t[r]=n[r]);return t};var i=(n,e,t)=>(O(n,typeof e!="symbol"?e+"":e,t),t);var R=class{constructor(){i(this,"managers",{});i(this,"reactions",{})}addReaction(e,t){this.reactions[e]=t}deleteReaction(e){return delete this.reactions[e]}getReaction(e){return this.reactions[e]}addManager(e){this.managers[e.name]=e}getManager(e){return this.managers[e]}getManagerByPathRecursive(e,[t,...r]){return e.name===t?e:r.length?this.getManagerByPathRecursive(e.managers[t],r):e.managers[t]}getManagerByPath([e,...t]){return this.getManagerByPathRecursive(this.managers[e],t)}},u=new R;var A=(n=21)=>crypto.getRandomValues(new Uint8Array(n)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function B(n){return n&&typeof n=="object"&&!Array.isArray(n)}function W(n){return n&&{}.toString.call(n)==="[object Function]"}function I(n="ObservableState"){return`${n}$${A(4)}`}function g(n){return Promise.resolve().then(n)}function z(n,e=[]){let t=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(n)),r={};for(let s in t){let a=t[s];!a.writable&&a.get&&!a.set&&!e.includes(s)&&(r[s]=a)}return r}function $(n,e){return n.length!==e.length?!1:n.every(t=>e.indexOf(t)!==-1)}function d(n,e){return Array.isArray(n)?new f(n,e):B(n)?new m(n,e):n instanceof Set||n instanceof Map?n:new P(n,e)}var w=class{constructor(){i(this,"batches",[])}get hasBatch(){return this.batches.length>0}open(){this.batches.push(new Set)}action(e){if(!this.hasBatch)return e();this.batches[this.batches.length-1].add(e)}closeBatch(){let e=this.batches.pop();e&&e.forEach(t=>t())}},st=new w,b=st;var T=class{constructor(e,t){this.value=e;this.manager=t;i(this,"children",{});i(this,"listenTypes",[])}get keys(){return Object.keys(this.children)}push([e,...t]){let r=this.children[e]||new T(e,this.manager.getManager(e));if(this.children[e]=r,!!t.length)return r.push(t)}},N=class{constructor(e){i(this,"nodes",{});for(let[t,...r]of e)this.nodes[t]=this.nodes[t]||new T(t,u.getManager(t)),this.nodes[t].push(r);for(let t in this.nodes)this.linkingRecursive(this.nodes[t])}linkingRecursive(e){let t=Object.keys(e.children);if(!t.length)return e.listenTypes=["all"];e.listenTypes=$(t,e.manager.keys)?["add","change","remove"]:["change"];for(let r of t)this.linkingRecursive(e.children[r])}optimizedManagersRec(e){let t=[{listenTypes:e.listenTypes,manager:e.manager}];if(!e.keys.length)return t;for(let r in e.children)t=t.concat(this.optimizedManagersRec(e.children[r]));return t}getListenManagers(){let e=[];for(let t in this.nodes)e=e.concat(this.optimizedManagersRec(this.nodes[t]));return e}},y=N;var j=class{constructor(){i(this,"batches",new Set)}watch(e,t){this.register(t);let r=e();return this.unregister(t),r}register(e){this.batches.add(e)}unregister(e){this.batches.delete(e)}emit(e){this.batches.size&&Array.from(this.batches).pop()(e)}getCaptured(e){let t=[];return{result:this.watch(e,({path:s})=>{t.push(s)}),variables:new y(t)}}optimizePaths(e){return new y(e)}},at=new j,v=at;var c=class{constructor(e=`Reaction#${A(4)}`){this.id=e;i(this,"paths",[]);i(this,"unsubscribeFns",[]);i(this,"listener",({path:e})=>{this.paths.push(e)});i(this,"unlisten",()=>{this.unsubscribeFns.length&&(this.unsubscribeFns.forEach(e=>e()),this.unsubscribeFns=[])});u.addReaction(e,this)}getOptimizationTree(){return this.paths.length?new y(this.paths):null}dispose(){u.deleteReaction(this.id),this.paths=[],this.unlisten()}startWatch(){this.paths=[],v.register(this.listener)}endWatch(){v.unregister(this.listener)}watch(e){let t=this.getOptimizationTree();if(!t)return console.warn(`Instances for listen in reaction \`${this.id}\` not found. Reconsider the use of adverse reactions.`),()=>{};let r=t.getListenManagers(),s=()=>e(this.unlisten);return this.unlisten(),this.unsubscribeFns=r.map(({listenTypes:a,manager:o})=>o.listen(a,()=>{b.action(s)})),this.unlisten}syncCaptured(e){this.startWatch();let t=e();return this.endWatch(),t}};var E=class{constructor(){i(this,"listeners",new Set)}listen(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}emit(e){for(let t of this.listeners)if(t(e))break}},x=class{constructor(){i(this,"listenerMap",new Map);i(this,"observable",!0)}listen(e,t){if(!this.observable)return()=>{};Array.isArray(e);let r=[],s=Array.isArray(e)?e:[e];for(let a of s){let o=this.listenerMap.get(a)||new E;this.listenerMap.set(a,o),r.push(o.listen(t))}return()=>{r.forEach(a=>a())}}emit(e,t){if(!this.observable||t.current===t.prev)return;let r=this.listenerMap.get(e),s=this.listenerMap.get("all");r&&r.emit(t),s&&s.emit(t)}};var C=class extends x{constructor({path:t,annotation:r},s){super();i(this,"annotation",{});i(this,"path",[]);this.path=t,this.annotation=l(l({},s),r),this.observable=this.annotation.observable}dispose(){this.path=[],this.emit("dispose",{prev:this.snapshot})}reportUsage(){this.annotation.observable&&v.emit({path:this.path})}joinToPath(t){return[...this.path,String(t)]}get name(){return this.path[this.path.length-1]}get snapshot(){return this.target}get keys(){return[]}toString(){return String(this.snapshot)}},h=C;var D={observable:!0},G={observable:!0},H={observable:!0,memoised:!0},K={observable:!0};var V=class extends h{constructor(t,r){super(r,H);this.target=t;i(this,"reaction");i(this,"savedResult");i(this,"isMemoized",!1);i(this,"isChanged",!1);i(this,"managers");this.reaction=new c(`Computed#${this.path.join(".")}`),this.emit("define",{current:this.snapshot})}getManager(){return null}get snapshot(){return this.target()}get value(){let{memoised:t}=this.annotation;return t?()=>(this.reportUsage(),this.isMemoized&&!this.isChanged?this.savedResult:(this.savedResult=this.reaction.syncCaptured(this.target),this.isMemoized=!0,this.isChanged=!1,this.reaction.watch(()=>{this.isChanged=!0,g(()=>{this.emit("change",{current:void 0,prev:this.savedResult})})}),this.savedResult)):this.target}setValue(){return!1}dispose(){this.reaction.dispose(),super.dispose()}},k=class extends h{constructor(t,r){super(r,D);this.target=t;i(this,"managers",{});i(this,"proxy");i(this,"handlers",{deleteProperty:(t,r)=>{let s=this.managers[r],a=delete this.managers[r];return a&&(s.dispose(),this.emit("remove",{prev:s.value})),a},defineProperty:(t,r,s)=>{let a=this.defineProperty(r,s,this.annotationOptions.fields[String(r)]);return this.emit("add",{current:this.value}),a}});this.proxy=this.define(t)}get annotationOptions(){let t=this.target.annotation||{};return l({fields:{},getters:{}},t)}defineProperty(t,{value:r,configurable:s=!0,enumerable:a=!0},o){return this.managers[t]=d(r,{path:this.joinToPath(t),annotation:o}),Object.defineProperty(this.target,t,{configurable:s,enumerable:a,get:()=>this.managers[t].value,set:p=>this.managers[t].setValue(p)}),!0}defineComputed(t,o,a){var p=o,{get:r}=p,s=_(p,["get"]);this.managers[t]=new V(r.bind(this.target),{path:this.joinToPath(t),annotation:a}),Object.defineProperty(this.target,t,q(l({},s),{get:this.managers[t].value}))}get name(){return this.path[this.path.length-1]}get snapshot(){return Object.entries(this.managers).reduce((t,[r,s])=>Object.assign(t,{[r]:s.snapshot}),{})}get value(){return this.reportUsage(),this.proxy}get keys(){return Object.keys(this.managers)}setValue(t){this.target=t;let r=l({},this.target);return this.proxy=this.define(t),this.emit("change",{current:t,prev:r}),!0}clearManagers(){for(let t in this.managers)this.managers[t].dispose();this.managers={}}dispose(){super.dispose(),this.clearManagers()}getManager(t){return this.managers[t]}define(t){this.clearManagers();let r=new Proxy(t,this.handlers),s=z(t,["annotation"]),a=this.annotationOptions;for(let o in t)this.defineProperty(o,{value:t[o]},a.fields[o]);for(let o in s)this.defineComputed(o,s[o],a.getters[o]);return r}},m=k;var S=class extends h{constructor(t,r){super(r,G);this.target=t;this.emit("define",{current:t})}get value(){return this.reportUsage(),this.target}setValue(t){let r=this.target;return this.target=t,this.emit("change",{current:t,prev:r}),!0}getManager(){return null}},P=S;var F=class extends h{constructor(t,r){super(r,K);this.target=t;i(this,"managers",[]);i(this,"proxy");i(this,"handlers",{get:(t,r)=>{var o;let s=Number(r);if(!Number.isNaN(s))return(o=this.managers[s])==null?void 0:o.value;let a=this.target[r];return W(a)?(...p)=>a.call(this.proxy,...p):a},set:(t,r,s)=>{let a=Number(r);if(!Number.isNaN(a)){if(a in this.managers)return this.managers[a].setValue(s);try{return this.managers[a]=d(s,{path:this.joinToPath(r)}),this.target[a]=s,this.emit("add",{current:this.value}),!0}catch(o){return!1}}return this.target[r]=s,!0},deleteProperty:(t,r)=>{let s=Number(r);if(Number.isNaN(s)||!(s in this.target))return!1;let a=this.managers[s],o=this.target.splice(s,1).length===1;return o&&a&&(this.managers.splice(s,1),a.dispose()),o}});this.proxy=this.define(t),this.emit("define",{current:this.value})}setValue(t){let r=this.value;return this.target=t,this.proxy=this.define(t),this.emit("change",{current:t,prev:r}),!0}get snapshot(){return[...this.target]}get keys(){let t=[];for(let r in this.target)t.push(r);return t}get value(){return this.reportUsage(),this.proxy}getManager(t){return this.managers[Number(t)]}clearManagers(){for(let t of this.managers)t.dispose();this.managers=[]}dispose(){super.dispose(),this.clearManagers()}define(t){this.clearManagers();for(let r of t)this.managers.push(d(r,{path:this.joinToPath(String(this.managers.length))}));return new Proxy(t,this.handlers)}},f=F;function Y(n){return u.addManager(n),n.value}console.log(u);var J={object:n=>Y(new m(n,{path:[I()]})),class:n=>Y(new m(new n,{path:[I(n.name)]})),array:n=>new f(n,{path:[I()]}),map:n=>n,set:n=>n};function Q(n,e,{isEqual:t=(s,a)=>s===a,initialCall:r=!1}={}){let s=new c,a=s.syncCaptured(n);r&&e(a,void 0);let o=()=>{let p=s.syncCaptured(n);t(p,a)||(e(p,a),a=p),g(()=>s.watch(o))};return s.watch(o),()=>{s.dispose()}}function X(n){let e=new c;e.syncCaptured(n);let t=()=>{e.syncCaptured(n),g(()=>e.watch(t))};return e.watch(t),()=>{e.dispose()}}function Z(n,e=t=>Boolean(t)){let t=new c;return new Promise(r=>{let s=t.syncCaptured(n),a=o=>{e(o)&&(r(o),t.dispose())};t.watch(()=>{a(n())}),a(s)})}function tt(n){b.open(),n(),b.closeBatch()}})();
