"use strict";(()=>{var et=Object.defineProperty,rt=Object.defineProperties;var nt=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable;var O=(r,e,t)=>e in r?et(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,l=(r,e)=>{for(var t in e||(e={}))L.call(e,t)&&O(r,t,e[t]);if(y)for(var t of y(e))q.call(e,t)&&O(r,t,e[t]);return r},W=(r,e)=>rt(r,nt(e));var _=(r,e)=>{var t={};for(var n in r)L.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&y)for(var n of y(r))e.indexOf(n)<0&&q.call(r,n)&&(t[n]=r[n]);return t};var a=(r,e,t)=>(O(r,typeof e!="symbol"?e+"":e,t),t);var P=class{constructor(){a(this,"batches",[])}open(){this.batches.push(new Set)}action(e){if(!this.batches.length)return e();this.batches[this.batches.length-1].add(e)}close(){let e=this.batches.pop();e&&e.forEach(t=>t())}},z=P;var R=class{constructor(){a(this,"listeners",new Set)}register(e){this.listeners.add(e)}unregister(e){this.listeners.delete(e)}emit(e){this.listeners.size&&Array.from(this.listeners).pop()(e)}},D=R;var M=new Map,g=new D,f=new z,w=new Map;function st(){let r=0;return()=>r++}var A=st();function U(r){return r&&typeof r=="object"&&!Array.isArray(r)}function $(r){return typeof r=="function"}function x(r="ObservableState"){return`${r}#${A()}`}function m(r){return Promise.resolve().then(r)}function B(r,e=[]){let t=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(r)),n={};for(let s in t){let i=t[s];!i.writable&&i.get&&!i.set&&!e.includes(s)&&(n[s]=i)}return n}function G(r,e){return r.length!==e.length?!1:r.every(t=>e.indexOf(t)!==-1)}var u={observer:{observable:!0},value:{observable:!0},computed:{observable:!0,memoised:!0},array:{observable:!0}};function b(r,e){return Array.isArray(r)?new T(r,e):U(r)?new d(r,e):r instanceof Set||r instanceof Map?r:new N(r,e)}var j=class{constructor(){a(this,"listeners",new Set)}listen(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}emit(e){for(let t of this.listeners)if(t(e))break}},I=class{constructor(){a(this,"listenerMap",new Map);a(this,"observable",!0)}listen(e,t){if(!this.observable)return()=>{};let n=[],s=Array.isArray(e)?e:[e];for(let i of s){let o=this.listenerMap.get(i)||new j;this.listenerMap.set(i,o),n.push(o.listen(t))}return()=>{n.forEach(i=>i())}}emit(e,t){if(!this.observable||t.current===t.prev)return;let n=this.listenerMap.get(e),s=this.listenerMap.get("all");n&&n.emit(t),s&&s.emit(t)}};var C=class extends I{constructor({path:t,annotation:n},s){super();a(this,"annotation",{});a(this,"path",[]);this.path=t,this.annotation=l(l({},s),n),this.observable=this.annotation.observable}dispose(){this.path=[],this.disposeManagers(),this.emit("dispose",{prev:this.snapshot})}reportUsage(){this.annotation.observable&&g.emit({path:this.path})}joinToPath(t){return[...this.path,String(t)]}get name(){return this.path[this.path.length-1]}get snapshot(){return this.target}get keys(){return[]}toString(){return String(this.snapshot)}disposeManagers(){}},h=C;var v=class{constructor(e,t){this.value=e;this.manager=t;a(this,"children",{});a(this,"listenTypes",[])}get keys(){return Object.keys(this.children)}push([e,...t]){let n=this.children[e]||new v(e,this.manager.manager(e));if(this.children[e]=n,!!t.length)return n.push(t)}},E=class{constructor(e){a(this,"nodes",{});for(let[t,...n]of e)this.nodes[t]=this.nodes[t]||new v(t,M.get(t)),this.nodes[t].push(n);for(let t in this.nodes)this.linkingRec(this.nodes[t])}linkingRec(e){let t=Object.keys(e.children);if(!t.length)return e.listenTypes=["all"];e.listenTypes=G(t,e.manager.keys)?["add","change","remove"]:["change"];for(let n of t)this.linkingRec(e.children[n])}optimizedRec(e){let t=[{listenTypes:e.listenTypes,manager:e.manager}];if(!e.keys.length)return t;for(let n in e.children)t=t.concat(this.optimizedRec(e.children[n]));return t}getListenManagers(){let e=[];for(let t in this.nodes)e=e.concat(this.optimizedRec(this.nodes[t]));return e}},H=E;var c=class{constructor(e=`Reaction#${A()}`){this.id=e;a(this,"paths",[]);a(this,"unsubscribeFns",[]);a(this,"listener",({path:e})=>{this.paths.push(e)});a(this,"unlisten",()=>{this.unsubscribeFns.length&&(this.unsubscribeFns.forEach(e=>e()),this.unsubscribeFns=[])});w.set(e,this)}getPathTree(){return this.paths.length?new H(this.paths):null}dispose(){w.delete(this.id),this.paths=[],this.unlisten()}startWatch(){this.paths=[],g.register(this.listener)}endWatch(){g.unregister(this.listener)}watch(e){let t=this.getPathTree();if(!t)return console.warn(`Instances for listen in reaction \`${this.id}\` not found. Reconsider the use of adverse reactions.`),()=>{};let n=t.getListenManagers(),s=()=>e(this.unlisten);return this.unlisten(),this.unsubscribeFns=n.map(({listenTypes:i,manager:o})=>o.listen(i,()=>{f.action(s)})),this.unlisten}syncCaptured(e){this.startWatch();let t=e();return this.endWatch(),t}};var S=class extends h{constructor(t,n){super(n,u.computed);this.target=t;a(this,"reaction");a(this,"savedResult");a(this,"isMemoized",!1);a(this,"isChanged",!1);a(this,"managers",null);this.reaction=new c(`Computed#${this.path.join(".")}`),this.emit("define",{current:this.snapshot})}manager(){return null}get snapshot(){return this.target()}get value(){let{memoised:t}=this.annotation;return t?()=>(this.reportUsage(),this.isMemoized&&!this.isChanged?this.savedResult:(this.savedResult=this.reaction.syncCaptured(this.target),this.isMemoized=!0,this.isChanged=!1,this.reaction.watch(()=>{this.isChanged=!0,m(()=>{this.emit("change",{current:void 0,prev:this.savedResult})})}),this.savedResult)):this.target}set(){return!1}dispose(){this.reaction.dispose(),super.dispose()}},K=S;var F=class extends h{constructor(t,n){super(n,u.observer);this.target=t;a(this,"managers",{});a(this,"proxy");a(this,"handlers",{deleteProperty:(t,n)=>{let s=this.managers[n],i=delete this.managers[n];return i&&(s.dispose(),this.emit("remove",{prev:s.value})),i},defineProperty:(t,n,s)=>{let i=this.defineProp(n,s,this.annotations.fields[String(n)]);return this.emit("add",{current:this.value}),i}});this.proxy=this.define(t)}get annotations(){let t=this.target.annotation||{};return l({fields:{},getters:{}},t)}defineProp(t,{value:n,configurable:s=!0,enumerable:i=!0},o){return this.managers[t]=b(n,{path:this.joinToPath(t),annotation:o}),Object.defineProperty(this.target,t,{configurable:s,enumerable:i,get:()=>this.managers[t].value,set:p=>this.managers[t].set(p)}),!0}defineComp(t,o,i){var p=o,{get:n}=p,s=_(p,["get"]);this.managers[t]=new K(n.bind(this.target),{path:this.joinToPath(t),annotation:i}),Object.defineProperty(this.target,t,W(l({},s),{get:this.managers[t].value}))}get snapshot(){return Object.entries(this.managers).reduce((t,[n,s])=>Object.assign(t,{[n]:s.snapshot}),{})}get value(){return this.reportUsage(),this.proxy}get keys(){return Object.keys(this.managers)}set(t){this.target=t;let n=l({},this.target);return this.proxy=this.define(t),this.emit("change",{current:t,prev:n}),!0}disposeManagers(){for(let t in this.managers)this.managers[t].dispose();this.managers={}}manager(t){return this.managers[t]}define(t){this.disposeManagers();let n=new Proxy(t,this.handlers),s=B(t,["annotation"]),i=this.annotations;for(let o in t)this.defineProp(o,{value:t[o]},i.fields[o]);for(let o in s)this.defineComp(o,s[o],i.getters[o]);return n}},d=F;var k=class extends h{constructor(t,n){super(n,u.value);this.target=t;this.emit("define",{current:t})}get value(){return this.reportUsage(),this.target}set(t){let n=this.target;return this.target=t,this.emit("change",{current:t,prev:n}),!0}manager(){return null}},N=k;var V=class extends h{constructor(t,n){super(n,u.array);this.target=t;a(this,"managers",[]);a(this,"proxy");a(this,"handlers",{get:(t,n)=>{var o;let s=Number(n);if(!Number.isNaN(s))return(o=this.managers[s])==null?void 0:o.value;let i=this.target[n];return $(i)?(...p)=>i.call(this.proxy,...p):i},set:(t,n,s)=>{let i=Number(n);if(!Number.isNaN(i)){if(i in this.managers)return this.managers[i].set(s);try{return this.managers[i]=b(s,{path:this.joinToPath(n)}),this.target[i]=s,this.emit("add",{current:this.value}),!0}catch(o){return!1}}return this.target[n]=s,!0},deleteProperty:(t,n)=>{let s=Number(n);if(Number.isNaN(s)||!(s in this.target))return!1;let i=this.managers[s],o=this.target.splice(s,1).length===1;return o&&i&&(this.managers.splice(s,1),i.dispose()),o}});this.proxy=this.define(t),this.emit("define",{current:this.value})}set(t){let n=this.value;return this.target=t,this.proxy=this.define(t),this.emit("change",{current:t,prev:n}),!0}get snapshot(){return[...this.target]}get keys(){let t=[];for(let n in this.target)t.push(n);return t}get value(){return this.reportUsage(),this.proxy}manager(t){return this.managers[Number(t)]}disposeManagers(){for(let t of this.managers)t.dispose();this.managers=[]}define(t){this.disposeManagers();for(let n of t)this.managers.push(b(n,{path:this.joinToPath(String(this.managers.length))}));return new Proxy(t,this.handlers)}},T=V;function J(r){return M.set(r.name,r),r.value}var Q={object:r=>J(new d(r,{path:[x()]})),class:r=>J(new d(new r,{path:[x(r.name)]})),array:r=>new T(r,{path:[x()]}),map:r=>r,set:r=>r};function X(r,e,{isEqual:t=(s,i)=>s===i,initialCall:n=!1}={}){let s=new c,i=s.syncCaptured(r);n&&e(i,void 0);let o=()=>{let p=s.syncCaptured(r);t(p,i)||(e(p,i),i=p),m(()=>s.watch(o))};return s.watch(o),()=>{s.dispose()}}function Y(r){let e=new c;e.syncCaptured(r);let t=()=>{e.syncCaptured(r),m(()=>e.watch(t))};return e.watch(t),()=>{e.dispose()}}function Z(r,e=t=>Boolean(t)){let t=new c;return new Promise(n=>{let s=t.syncCaptured(r),i=o=>{e(o)&&(n(o),t.dispose())};t.watch(()=>{i(r())}),i(s)})}function tt(r){f.open(),r(),f.close()}})();
