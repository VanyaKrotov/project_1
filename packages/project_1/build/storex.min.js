"use strict";(()=>{var bt=Object.defineProperty,ft=Object.defineProperties;var Tt=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var tt=Object.prototype.hasOwnProperty,et=Object.prototype.propertyIsEnumerable;var C=(r,e,t)=>e in r?bt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,d=(r,e)=>{for(var t in e||(e={}))tt.call(e,t)&&C(r,t,e[t]);if(R)for(var t of R(e))et.call(e,t)&&C(r,t,e[t]);return r},nt=(r,e)=>ft(r,Tt(e));var rt=(r,e)=>{var t={};for(var n in r)tt.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&R)for(var n of R(r))e.indexOf(n)<0&&et.call(r,n)&&(t[n]=r[n]);return t};var a=(r,e,t)=>(C(r,typeof e!="symbol"?e+"":e,t),t);var st=(r,e,t)=>new Promise((n,s)=>{var i=h=>{try{c(t.next(h))}catch(j){s(j)}},o=h=>{try{c(t.throw(h))}catch(j){s(j)}},c=h=>h.done?n(h.value):Promise.resolve(h.value).then(i,o);c((t=t.apply(r,e)).next())});var k=class{constructor(){a(this,"managers",{});a(this,"reactions",{})}addReaction(e,t){this.reactions[e]=t}deleteReaction(e){return delete this.reactions[e]}getReaction(e){return this.reactions[e]}addManager(e){this.managers[e.name]=e}getManager(e){return this.managers[e]}getManagerByPathRecursive(e,[t,...n]){return e.name===t?e:n.length?this.getManagerByPathRecursive(e.managers[t],n):e.managers[t]}getManagerByPath([e,...t]){return this.getManagerByPathRecursive(this.managers[e],t)}},l=new k;var w=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function it(r){return r&&typeof r=="object"&&!Array.isArray(r)}function at(r){return r&&{}.toString.call(r)==="[object Function]"}function P(r="ObservableState"){return`${r}$${w(4)}`}function m(r){return Promise.resolve().then(r)}function ot(r,e=[]){let t=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(r)),n={};for(let s in t){let i=t[s];!i.writable&&i.get&&!i.set&&!e.includes(s)&&(n[s]=i)}return n}function y(r,e){return Array.isArray(r)?new v(r,e):it(r)?new b(r,e):r instanceof Set||r instanceof Map?r:new V(r,e)}var f=class{constructor(e,t){this.value=e;this.manager=t;a(this,"children",{});a(this,"listenTypes",[])}get keys(){return Object.keys(this.children)}pushPath([e,...t]){var s;let n=this.children[e]||new f(e,((s=this.manager)==null?void 0:s.getManager(e))||null);if(this.children[e]=n,!!t.length)return n.pushPath(t)}};function yt(r,e){return r.length!==e.length?!1:r.every(t=>e.indexOf(t)!==-1)}var M=class extends f{constructor(e){super("",null),this.children=M.createNodesFromPaths(e),this.linking()}static createNodesFromPaths(e){let t={};for(let n of e){let[s,...i]=n;t[s]=t[s]||new f(s,l.getManager(s)),t[s].pushPath(i)}return t}linkingRecursive(e){let t=Object.keys(e.children);if(!t.length)return e.listenTypes=["all"];e.listenTypes=yt(t,e.manager.keys)?["add","change","remove"]:["change"];for(let n of t)this.linkingRecursive(e.children[n])}linking(){for(let e in this.children)this.linkingRecursive(this.children[e])}optimizedManagersRec(e){let t=[{listenTypes:e.listenTypes,manager:e.manager}];if(!e.keys.length)return t;for(let n in e.children)t=t.concat(this.optimizedManagersRec(e.children[n]));return t}getListenManagers(){let e=[];for(let t in this.children)e=e.concat(this.optimizedManagersRec(this.children[t]));return e}};var A=M;var B=class{constructor(){a(this,"batches",[])}get hasBatch(){return this.batches.length>0}open(){this.batches.push(new Set)}action(e){if(!this.hasBatch)return e();this.batches[this.batches.length-1].add(e)}closeBatch(){let e=this.batches.pop();e&&e.forEach(t=>t())}},L=class{constructor(){a(this,"batches",new Set)}watch(e,t){this.register(t);let n=e();return this.unregister(t),n}register(e){this.batches.add(e)}unregister(e){this.batches.delete(e)}emit(e){this.batches.size&&Array.from(this.batches).pop()(e)}getCaptured(e){let t=[];return{result:this.watch(e,({path:s})=>{t.push(s)}),variables:new A(t)}}optimizePaths(e){return new A(e)}},x=new B,O=new L;var u=class{constructor(e=`Reaction#${w(4)}`){this.id=e;a(this,"paths",[]);a(this,"unsubscribeFns",[]);a(this,"listener",({path:e})=>{this.paths.push(e)});a(this,"unlisten",()=>{this.unsubscribeFns.length&&(this.unsubscribeFns.forEach(e=>e()),this.unsubscribeFns=[])});l.addReaction(e,this)}getOptimizationTree(){return this.paths.length?new A(this.paths):null}dispose(){l.deleteReaction(this.id),this.paths=[],this.unlisten()}startWatch(){this.paths=[],O.register(this.listener)}endWatch(){O.unregister(this.listener)}watch(e){let t=this.getOptimizationTree();if(!t)return console.warn(`Instances for listen in reaction \`${this.id}\` not found. Reconsider the use of adverse reactions.`),()=>{};let n=t.getListenManagers(),s=()=>e(this.unlisten);return this.unlisten(),this.unsubscribeFns=n.map(({listenTypes:i,manager:o})=>o.listen(i,()=>{x.action(s)})),this.unlisten}syncCaptured(e){this.startWatch();let t=e();return this.endWatch(),t}};var F=class{constructor(){a(this,"listeners",new Set)}listen(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}emit(e){for(let t of this.listeners)if(t(e))break}},N=class{constructor(){a(this,"listenerMap",new Map);a(this,"observable",!0)}listen(e,t){if(!this.observable)return()=>{};Array.isArray(e);let n=[],s=Array.isArray(e)?e:[e];for(let i of s){let o=this.listenerMap.get(i)||new F;this.listenerMap.set(i,o),n.push(o.listen(t))}return()=>{n.forEach(i=>i())}}emit(e,t){if(!this.observable||t.current===t.prev)return;let n=this.listenerMap.get(e),s=this.listenerMap.get("all");n&&n.emit(t),s&&s.emit(t)}};var S=class extends N{constructor({path:t,annotation:n},s){super();a(this,"annotation",{});a(this,"path",[]);this.path=t,this.annotation=d(d({},s),n),this.observable=this.annotation.observable}dispose(){this.path=[],this.emit("dispose",{prev:this.snapshot})}reportUsage(){this.annotation.observable&&O.emit({path:this.path})}joinToPath(t){return[...this.path,String(t)]}get name(){return this.path[this.path.length-1]}get snapshot(){return this.target}get keys(){return[]}toString(){return String(this.snapshot)}},g=S;var ct={observable:!0},ut={observable:!0},pt={observable:!0,memoised:!0},lt={observable:!0};var U=class extends g{constructor(t,n){super(n,pt);this.target=t;a(this,"reaction");a(this,"savedResult");a(this,"isMemoized",!1);a(this,"isChanged",!1);a(this,"managers");this.reaction=new u(`Computed#${this.path.join(".")}`),this.emit("define",{current:this.snapshot})}getManager(){return null}get snapshot(){return this.target()}get value(){let{memoised:t}=this.annotation;return t?()=>(this.reportUsage(),this.isMemoized&&!this.isChanged?this.savedResult:(this.savedResult=this.reaction.syncCaptured(this.target),this.isMemoized=!0,this.isChanged=!1,this.reaction.watch(()=>{this.isChanged=!0,m(()=>{this.emit("change",{current:void 0,prev:this.savedResult})})}),this.savedResult)):this.target}setValue(){return!1}dispose(){this.reaction.dispose(),super.dispose()}},z=class extends g{constructor(t,n){super(n,ct);this.target=t;a(this,"managers",{});a(this,"proxy");a(this,"handlers",{deleteProperty:(t,n)=>{let s=this.managers[n],i=delete this.managers[n];return i&&(s.dispose(),this.emit("remove",{prev:s.value})),i},defineProperty:(t,n,s)=>{let i=this.defineProperty(n,s,this.annotationOptions.fields[String(n)]);return this.emit("add",{current:this.value}),i}});this.proxy=this.define(t)}get annotationOptions(){let t=this.target.annotation||{};return d({fields:{},getters:{}},t)}defineProperty(t,{value:n,configurable:s=!0,enumerable:i=!0},o){return this.managers[t]=y(n,{path:this.joinToPath(t),annotation:o}),Object.defineProperty(this.target,t,{configurable:s,enumerable:i,get:()=>this.managers[t].value,set:c=>this.managers[t].setValue(c)}),!0}defineComputed(t,o,i){var c=o,{get:n}=c,s=rt(c,["get"]);this.managers[t]=new U(n.bind(this.target),{path:this.joinToPath(t),annotation:i}),Object.defineProperty(this.target,t,nt(d({},s),{get:this.managers[t].value}))}get name(){return this.path[this.path.length-1]}get snapshot(){return Object.entries(this.managers).reduce((t,[n,s])=>Object.assign(t,{[n]:s.snapshot}),{})}get value(){return this.reportUsage(),this.proxy}get keys(){return Object.keys(this.managers)}setValue(t){this.target=t;let n=d({},this.target);return this.proxy=this.define(t),this.emit("change",{current:t,prev:n}),!0}clearManagers(){for(let t in this.managers)this.managers[t].dispose();this.managers={}}dispose(){super.dispose(),this.clearManagers()}getManager(t){return this.managers[t]}define(t){this.clearManagers();let n=new Proxy(t,this.handlers),s=ot(t,["annotation"]),i=this.annotationOptions;for(let o in t)this.defineProperty(o,{value:t[o]},i.fields[o]);for(let o in s)this.defineComputed(o,s[o],i.getters[o]);return n}},b=z;var q=class extends g{constructor(t,n){super(n,ut);this.target=t;this.emit("define",{current:t})}get value(){return this.reportUsage(),this.target}setValue(t){let n=this.target;return this.target=t,this.emit("change",{current:t,prev:n}),!0}getManager(){return null}},V=q;var W=class extends g{constructor(t,n){super(n,lt);this.target=t;a(this,"managers",[]);a(this,"proxy");a(this,"handlers",{get:(t,n)=>{var o;let s=Number(n);if(!Number.isNaN(s))return(o=this.managers[s])==null?void 0:o.value;let i=this.target[n];return at(i)?(...c)=>i.call(this.proxy,...c):i},set:(t,n,s)=>{let i=Number(n);if(!Number.isNaN(i)){if(i in this.managers)return this.managers[i].setValue(s);try{return this.managers[i]=y(s,{path:this.joinToPath(n)}),this.target[i]=s,this.emit("add",{current:this.value}),!0}catch(o){return!1}}return this.target[n]=s,!0},deleteProperty:(t,n)=>{let s=Number(n);if(Number.isNaN(s)||!(s in this.target))return!1;let i=this.managers[s],o=this.target.splice(s,1).length===1;return o&&i&&(this.managers.splice(s,1),i.dispose()),o}});this.proxy=this.define(t),this.emit("define",{current:this.value})}setValue(t){let n=this.value;return this.target=t,this.proxy=this.define(t),this.emit("change",{current:t,prev:n}),!0}get snapshot(){return[...this.target]}get keys(){let t=[];for(let n in this.target)t.push(n);return t}get value(){return this.reportUsage(),this.proxy}getManager(t){return this.managers[Number(t)]}clearManagers(){for(let t of this.managers)t.dispose();this.managers=[]}dispose(){super.dispose(),this.clearManagers()}define(t){this.clearManagers();for(let n of t)this.managers.push(y(n,{path:this.joinToPath(String(this.managers.length))}));return new Proxy(t,this.handlers)}},v=W;function ht(r){return l.addManager(r),r.value}console.log(l);var I={object:r=>ht(new b(r,{path:[P()]})),class:r=>ht(new b(new r,{path:[P(r.name)]})),array:r=>new v(r,{path:[P()]}),map:()=>new Map,set:()=>new Set};function dt(r,e,{isEqual:t=(s,i)=>s===i,initialCall:n=!1}={}){let s=new u,i=s.syncCaptured(r);n&&e(i,void 0);let o=()=>{let c=s.syncCaptured(r);t(c,i)||(e(c,i),i=c),m(()=>s.watch(o))};return s.watch(o),()=>{s.dispose()}}function T(r){let e=new u;e.syncCaptured(r);let t=()=>{e.syncCaptured(r),m(()=>e.watch(t))};return e.watch(t),()=>{e.dispose()}}function E(r,e=t=>Boolean(t)){let t=new u;return new Promise(n=>{let s=t.syncCaptured(r),i=o=>{e(o)&&(n(o),t.dispose())};t.watch(()=>{i(r())}),i(s)})}function _(r){x.open(),r(),x.closeBatch()}var $=class{constructor(){a(this,"counter",1);a(this,"array",[10,23])}get mul(){return this.counter*2}},D=class extends ${increment(){this.counter++}decrement(){this.counter--}fetch(){return st(this,null,function*(){this.array[0]=this.counter+1})}push(){_(()=>{this.counter++,this.array.push(this.array.length*this.counter),this.counter++})}},vt={counter:1,inc(){this.counter++},dec(){this.counter--}},p=I.class(D),G=I.object(vt);console.log(p);var H=document.createElement("div"),gt=document.createElement("div"),mt=document.createElement("div"),Y=document.createElement("button"),J=document.createElement("button"),K=document.createElement("button"),Q=document.createElement("button"),X=document.createElement("button"),Z=document.createElement("button");J.innerText="-";Y.innerText="+";K.innerText="+";Q.innerText="-";X.innerText="fetch";Z.innerText="push";T(()=>{console.log("trigger counter"),H.innerText=`state: ${p.counter}`});T(()=>{console.log("trigger stateObj"),gt.innerText=`stateObj: ${G.counter}`});T(()=>{console.log("trigger array"),mt.innerText=`arr: ${JSON.stringify(p.array)}`,H.innerText=`state: ${p.counter}`});E(()=>p.counter>3).then(()=>{console.log("test")});Y.addEventListener("click",()=>{p.increment()});J.addEventListener("click",()=>{p.decrement()});K.addEventListener("click",()=>{G.inc()});Q.addEventListener("click",()=>{G.dec()});X.addEventListener("click",()=>{p.fetch()});Z.addEventListener("click",()=>{p.push()});document.body.appendChild(H);document.body.appendChild(gt);document.body.appendChild(mt);document.body.appendChild(Y);document.body.appendChild(J);document.body.appendChild(K);document.body.appendChild(Q);document.body.appendChild(X);document.body.appendChild(Z);})();
