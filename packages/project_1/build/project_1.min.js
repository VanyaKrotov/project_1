"use strict";(()=>{var et=Object.defineProperty,rt=Object.defineProperties;var nt=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var L=Object.prototype.hasOwnProperty,U=Object.prototype.propertyIsEnumerable;var R=(r,e,t)=>e in r?et(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,l=(r,e)=>{for(var t in e||(e={}))L.call(e,t)&&R(r,t,e[t]);if(A)for(var t of A(e))U.call(e,t)&&R(r,t,e[t]);return r},z=(r,e)=>rt(r,nt(e));var q=(r,e)=>{var t={};for(var n in r)L.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&A)for(var n of A(r))e.indexOf(n)<0&&U.call(r,n)&&(t[n]=r[n]);return t};var a=(r,e,t)=>(R(r,typeof e!="symbol"?e+"":e,t),t);var w=class{constructor(){a(this,"managers",{});a(this,"reactions",{})}addReaction(e,t){this.reactions[e]=t}deleteReaction(e){return delete this.reactions[e]}getReaction(e){return this.reactions[e]}addManager(e){this.managers[e.name]=e}getManager(e){return this.managers[e]}getManagerByPathRecursive(e,[t,...n]){return e.name===t?e:n.length?this.getManagerByPathRecursive(e.managers[t],n):e.managers[t]}getManagerByPath([e,...t]){return this.getManagerByPathRecursive(this.managers[e],t)}},u=new w;var x=(r=21)=>crypto.getRandomValues(new Uint8Array(r)).reduce((e,t)=>(t&=63,t<36?e+=t.toString(36):t<62?e+=(t-26).toString(36).toUpperCase():t>62?e+="-":e+="_",e),"");function B(r){return r&&typeof r=="object"&&!Array.isArray(r)}function W(r){return r&&{}.toString.call(r)==="[object Function]"}function I(r="ObservableState"){return`${r}$${x(4)}`}function g(r){return Promise.resolve().then(r)}function _(r,e=[]){let t=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(r)),n={};for(let s in t){let i=t[s];!i.writable&&i.get&&!i.set&&!e.includes(s)&&(n[s]=i)}return n}function $(r,e){return r.length!==e.length?!1:r.every(t=>e.indexOf(t)!==-1)}function f(r,e){return Array.isArray(r)?new b(r,e):B(r)?new m(r,e):r instanceof Set||r instanceof Map?r:new P(r,e)}var N=class{constructor(){a(this,"batches",[])}get hasBatch(){return this.batches.length>0}open(){this.batches.push(new Set)}action(e){if(!this.hasBatch)return e();this.batches[this.batches.length-1].add(e)}closeBatch(){let e=this.batches.pop();e&&e.forEach(t=>t())}},st=new N,T=st;var d=class{constructor(e,t){this.value=e;this.manager=t;a(this,"children",{});a(this,"listenTypes",[])}get keys(){return Object.keys(this.children)}pushPath([e,...t]){var s;let n=this.children[e]||new d(e,((s=this.manager)==null?void 0:s.getManager(e))||null);if(this.children[e]=n,!!t.length)return n.pushPath(t)}},y=class extends d{constructor(e){super("",null),this.children=y.createNodesFromPaths(e),this.linking()}static createNodesFromPaths(e){let t={};for(let n of e){let[s,...i]=n;t[s]=t[s]||new d(s,u.getManager(s)),t[s].pushPath(i)}return t}linkingRecursive(e){let t=Object.keys(e.children);if(!t.length)return e.listenTypes=["all"];e.listenTypes=$(t,e.manager.keys)?["add","change","remove"]:["change"];for(let n of t)this.linkingRecursive(e.children[n])}linking(){for(let e in this.children)this.linkingRecursive(this.children[e])}optimizedManagersRec(e){let t=[{listenTypes:e.listenTypes,manager:e.manager}];if(!e.keys.length)return t;for(let n in e.children)t=t.concat(this.optimizedManagersRec(e.children[n]));return t}getListenManagers(){let e=[];for(let t in this.children)e=e.concat(this.optimizedManagersRec(this.children[t]));return e}},v=y;var j=class{constructor(){a(this,"batches",new Set)}watch(e,t){this.register(t);let n=e();return this.unregister(t),n}register(e){this.batches.add(e)}unregister(e){this.batches.delete(e)}emit(e){this.batches.size&&Array.from(this.batches).pop()(e)}getCaptured(e){let t=[];return{result:this.watch(e,({path:s})=>{t.push(s)}),variables:new v(t)}}optimizePaths(e){return new v(e)}},it=new j,M=it;var c=class{constructor(e=`Reaction#${x(4)}`){this.id=e;a(this,"paths",[]);a(this,"unsubscribeFns",[]);a(this,"listener",({path:e})=>{this.paths.push(e)});a(this,"unlisten",()=>{this.unsubscribeFns.length&&(this.unsubscribeFns.forEach(e=>e()),this.unsubscribeFns=[])});u.addReaction(e,this)}getOptimizationTree(){return this.paths.length?new v(this.paths):null}dispose(){u.deleteReaction(this.id),this.paths=[],this.unlisten()}startWatch(){this.paths=[],M.register(this.listener)}endWatch(){M.unregister(this.listener)}watch(e){let t=this.getOptimizationTree();if(!t)return console.warn(`Instances for listen in reaction \`${this.id}\` not found. Reconsider the use of adverse reactions.`),()=>{};let n=t.getListenManagers(),s=()=>e(this.unlisten);return this.unlisten(),this.unsubscribeFns=n.map(({listenTypes:i,manager:o})=>o.listen(i,()=>{T.action(s)})),this.unlisten}syncCaptured(e){this.startWatch();let t=e();return this.endWatch(),t}};var E=class{constructor(){a(this,"listeners",new Set)}listen(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}emit(e){for(let t of this.listeners)if(t(e))break}},O=class{constructor(){a(this,"listenerMap",new Map);a(this,"observable",!0)}listen(e,t){if(!this.observable)return()=>{};Array.isArray(e);let n=[],s=Array.isArray(e)?e:[e];for(let i of s){let o=this.listenerMap.get(i)||new E;this.listenerMap.set(i,o),n.push(o.listen(t))}return()=>{n.forEach(i=>i())}}emit(e,t){if(!this.observable||t.current===t.prev)return;let n=this.listenerMap.get(e),s=this.listenerMap.get("all");n&&n.emit(t),s&&s.emit(t)}};var C=class extends O{constructor({path:t,annotation:n},s){super();a(this,"annotation",{});a(this,"path",[]);this.path=t,this.annotation=l(l({},s),n),this.observable=this.annotation.observable}dispose(){this.path=[],this.emit("dispose",{prev:this.snapshot})}reportUsage(){this.annotation.observable&&M.emit({path:this.path})}joinToPath(t){return[...this.path,String(t)]}get name(){return this.path[this.path.length-1]}get snapshot(){return this.target}get keys(){return[]}toString(){return String(this.snapshot)}},h=C;var D={observable:!0},G={observable:!0},H={observable:!0,memoised:!0},K={observable:!0};var V=class extends h{constructor(t,n){super(n,H);this.target=t;a(this,"reaction");a(this,"savedResult");a(this,"isMemoized",!1);a(this,"isChanged",!1);a(this,"managers");this.reaction=new c(`Computed#${this.path.join(".")}`),this.emit("define",{current:this.snapshot})}getManager(){return null}get snapshot(){return this.target()}get value(){let{memoised:t}=this.annotation;return t?()=>(this.reportUsage(),this.isMemoized&&!this.isChanged?this.savedResult:(this.savedResult=this.reaction.syncCaptured(this.target),this.isMemoized=!0,this.isChanged=!1,this.reaction.watch(()=>{this.isChanged=!0,g(()=>{this.emit("change",{current:void 0,prev:this.savedResult})})}),this.savedResult)):this.target}setValue(){return!1}dispose(){this.reaction.dispose(),super.dispose()}},k=class extends h{constructor(t,n){super(n,D);this.target=t;a(this,"managers",{});a(this,"proxy");a(this,"handlers",{deleteProperty:(t,n)=>{let s=this.managers[n],i=delete this.managers[n];return i&&(s.dispose(),this.emit("remove",{prev:s.value})),i},defineProperty:(t,n,s)=>{let i=this.defineProperty(n,s,this.annotationOptions.fields[String(n)]);return this.emit("add",{current:this.value}),i}});this.proxy=this.define(t)}get annotationOptions(){let t=this.target.annotation||{};return l({fields:{},getters:{}},t)}defineProperty(t,{value:n,configurable:s=!0,enumerable:i=!0},o){return this.managers[t]=f(n,{path:this.joinToPath(t),annotation:o}),Object.defineProperty(this.target,t,{configurable:s,enumerable:i,get:()=>this.managers[t].value,set:p=>this.managers[t].setValue(p)}),!0}defineComputed(t,o,i){var p=o,{get:n}=p,s=q(p,["get"]);this.managers[t]=new V(n.bind(this.target),{path:this.joinToPath(t),annotation:i}),Object.defineProperty(this.target,t,z(l({},s),{get:this.managers[t].value}))}get name(){return this.path[this.path.length-1]}get snapshot(){return Object.entries(this.managers).reduce((t,[n,s])=>Object.assign(t,{[n]:s.snapshot}),{})}get value(){return this.reportUsage(),this.proxy}get keys(){return Object.keys(this.managers)}setValue(t){this.target=t;let n=l({},this.target);return this.proxy=this.define(t),this.emit("change",{current:t,prev:n}),!0}clearManagers(){for(let t in this.managers)this.managers[t].dispose();this.managers={}}dispose(){super.dispose(),this.clearManagers()}getManager(t){return this.managers[t]}define(t){this.clearManagers();let n=new Proxy(t,this.handlers),s=_(t,["annotation"]),i=this.annotationOptions;for(let o in t)this.defineProperty(o,{value:t[o]},i.fields[o]);for(let o in s)this.defineComputed(o,s[o],i.getters[o]);return n}},m=k;var F=class extends h{constructor(t,n){super(n,G);this.target=t;this.emit("define",{current:t})}get value(){return this.reportUsage(),this.target}setValue(t){let n=this.target;return this.target=t,this.emit("change",{current:t,prev:n}),!0}getManager(){return null}},P=F;var S=class extends h{constructor(t,n){super(n,K);this.target=t;a(this,"managers",[]);a(this,"proxy");a(this,"handlers",{get:(t,n)=>{var o;let s=Number(n);if(!Number.isNaN(s))return(o=this.managers[s])==null?void 0:o.value;let i=this.target[n];return W(i)?(...p)=>i.call(this.proxy,...p):i},set:(t,n,s)=>{let i=Number(n);if(!Number.isNaN(i)){if(i in this.managers)return this.managers[i].setValue(s);try{return this.managers[i]=f(s,{path:this.joinToPath(n)}),this.target[i]=s,this.emit("add",{current:this.value}),!0}catch(o){return!1}}return this.target[n]=s,!0},deleteProperty:(t,n)=>{let s=Number(n);if(Number.isNaN(s)||!(s in this.target))return!1;let i=this.managers[s],o=this.target.splice(s,1).length===1;return o&&i&&(this.managers.splice(s,1),i.dispose()),o}});this.proxy=this.define(t),this.emit("define",{current:this.value})}setValue(t){let n=this.value;return this.target=t,this.proxy=this.define(t),this.emit("change",{current:t,prev:n}),!0}get snapshot(){return[...this.target]}get keys(){let t=[];for(let n in this.target)t.push(n);return t}get value(){return this.reportUsage(),this.proxy}getManager(t){return this.managers[Number(t)]}clearManagers(){for(let t of this.managers)t.dispose();this.managers=[]}dispose(){super.dispose(),this.clearManagers()}define(t){this.clearManagers();for(let n of t)this.managers.push(f(n,{path:this.joinToPath(String(this.managers.length))}));return new Proxy(t,this.handlers)}},b=S;function Y(r){return u.addManager(r),r.value}console.log(u);var J={object:r=>Y(new m(r,{path:[I()]})),class:r=>Y(new m(new r,{path:[I(r.name)]})),array:r=>new b(r,{path:[I()]}),map:r=>r,set:r=>r};function Q(r,e,{isEqual:t=(s,i)=>s===i,initialCall:n=!1}={}){let s=new c,i=s.syncCaptured(r);n&&e(i,void 0);let o=()=>{let p=s.syncCaptured(r);t(p,i)||(e(p,i),i=p),g(()=>s.watch(o))};return s.watch(o),()=>{s.dispose()}}function X(r){let e=new c;e.syncCaptured(r);let t=()=>{e.syncCaptured(r),g(()=>e.watch(t))};return e.watch(t),()=>{e.dispose()}}function Z(r,e=t=>Boolean(t)){let t=new c;return new Promise(n=>{let s=t.syncCaptured(r),i=o=>{e(o)&&(n(o),t.dispose())};t.watch(()=>{i(r())}),i(s)})}function tt(r){T.open(),r(),T.closeBatch()}})();
